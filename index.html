<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è²»åˆ†å¸³ç¥å™¨</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* é ‚éƒ¨å°èˆª */
        .header {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
        }

        .btn-group { display: flex; gap: 10px; }
        
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-small { width: auto; padding: 5px 10px; font-size: 0.9rem; }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .list-item:last-child { border-bottom: none; }

        /* çµç®—çµæœå¼·èª¿ */
        .result-item {
            padding: 10px;
            background: #f0fdf4;
            border-left: 4px solid var(--success);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            border-top: 1px solid #e2e8f0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: #64748b;
            cursor: pointer;
        }
        .nav-item.active {
            color: var(--primary);
            font-weight: bold;
            border-top: 2px solid var(--primary);
        }

        /* é é¢åˆ‡æ› */
        .page { display: none; }
        .page.active { display: block; }

        /* æ¨™ç±¤ Tag */
        .tag {
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div class="header">åˆ†å¸³ç¥å™¨</div>

    <div id="page-log" class="page container active">
        <div class="card">
            <h2>ğŸ“ æ–°å¢æ”¯å‡º</h2>
            <input type="date" id="expense-date">
            <input type="text" id="expense-desc" placeholder="é …ç›® (ä¾‹å¦‚: æ™šé¤)">
            <input type="number" id="expense-amount" placeholder="é‡‘é¡" inputmode="numeric">
            <select id="expense-payer">
                <option value="" disabled selected>èª°å…ˆä»˜éŒ¢?</option>
                </select>
            <button class="btn-primary" onclick="addExpense()">åŠ å…¥é€™ç­†æ”¯å‡º</button>
        </div>

        <div class="card">
            <h2>ğŸ“… æ¯æ—¥æ˜ç´°</h2>
            <div id="expense-list">
                <div style="text-align:center; color:#94a3b8; padding:20px;">å°šç„¡ç´€éŒ„</div>
            </div>
        </div>
    </div>

    <div id="page-settings" class="page container">
        
        <div class="card">
            <h2>ğŸ’° æ™ºæ…§çµç®—</h2>
            <div style="margin-bottom:10px; font-weight:bold;">
                ç¸½æ”¯å‡º: <span id="total-amount">0</span> | å¹³å‡: <span id="average-amount">0</span>/äºº
            </div>
            <div id="settlement-plan">
                </div>
        </div>

        <div class="card">
            <h2>ğŸ‘¥ äººå“¡ç®¡ç†</h2>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="new-user-name" placeholder="è¼¸å…¥åå­—" style="margin-bottom:0;">
                <button class="btn-primary btn-small" onclick="addUser()">æ–°å¢</button>
            </div>
            <div id="user-list">
                </div>
        </div>

        <div class="card">
            <h2>ğŸ’¾ è³‡æ–™ç®¡ç†</h2>
            <div class="btn-group">
                <button class="btn-outline" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
                <button class="btn-outline" onclick="document.getElementById('import-file').click()">åŒ¯å…¥æª”æ¡ˆ</button>
                <input type="file" id="import-file" style="display:none" onchange="importData(this)" accept=".json">
            </div>
            <button class="btn-danger" style="margin-top:10px;" onclick="clearAllData()">å…¨éƒ¨æ¸…é™¤é‡ç½®</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('log')">è¨˜å¸³æ˜ç´°</div>
        <div class="nav-item" onclick="switchPage('settings')">çµç®—èˆ‡è¨­å®š</div>
    </div>

    <script>
        // --- 1. è³‡æ–™åˆå§‹åŒ– ---
        let users = JSON.parse(localStorage.getItem('split_users')) || [];
        let expenses = JSON.parse(localStorage.getItem('split_expenses')) || [];

        // é è¨­ä»Šå¤©æ—¥æœŸ
        document.getElementById('expense-date').valueAsDate = new Date();

        // å•Ÿå‹•æ™‚æ¸²æŸ“
        renderUsers();
        renderPayerOptions();
        renderExpenses();
        calculateSettlement();

        // --- 2. æ ¸å¿ƒåŠŸèƒ½ï¼šäººå“¡ç®¡ç† ---
        function addUser() {
            const nameInput = document.getElementById('new-user-name');
            const name = nameInput.value.trim();
            if (!name) return alert('è«‹è¼¸å…¥åå­—');
            if (users.includes(name)) return alert('åå­—é‡è¤‡å›‰');

            users.push(name);
            saveData();
            nameInput.value = '';
            renderUsers();
            renderPayerOptions();
            calculateSettlement(); // äººæ•¸è®Šå‹•æœƒå½±éŸ¿å¹³å‡
        }

        function removeUser(index) {
            const name = users[index];
            // ç°¡å–®æª¢æŸ¥ï¼šå¦‚æœè©²äººæœ‰ä»˜æ¬¾ç´€éŒ„ï¼Œè­¦å‘Š
            const hasRecord = expenses.some(e => e.payer === name);
            if (hasRecord) {
                if(!confirm(`${name} å·²ç¶“æœ‰ä»˜æ¬¾ç´€éŒ„ï¼Œåˆªé™¤å¯èƒ½å°è‡´å¸³å‹™éŒ¯èª¤ã€‚ç¢ºå®šåˆªé™¤ï¼Ÿ`)) return;
            }
            users.splice(index, 1);
            saveData();
            renderUsers();
            renderPayerOptions();
            calculateSettlement();
        }

        // --- 3. æ ¸å¿ƒåŠŸèƒ½ï¼šè¨˜å¸³ç®¡ç† ---
        function addExpense() {
            const date = document.getElementById('expense-date').value;
            const desc = document.getElementById('expense-desc').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payer = document.getElementById('expense-payer').value;

            if (!date || !desc || isNaN(amount) || !payer) {
                return alert('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½');
            }

            expenses.push({
                id: Date.now(), // å”¯ä¸€ID
                date,
                desc,
                amount,
                payer
            });

            // æŒ‰æ—¥æœŸæ’åº
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            saveData();
            
            // æ¸…ç©ºè¼¸å…¥ (æ—¥æœŸä¿ç•™)
            document.getElementById('expense-desc').value = '';
            document.getElementById('expense-amount').value = '';
            
            renderExpenses();
            calculateSettlement();
            alert('å·²æ–°å¢æ”¯å‡ºï¼');
        }

        function deleteExpense(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return;
            expenses = expenses.filter(e => e.id !== id);
            saveData();
            renderExpenses();
            calculateSettlement();
        }

        // --- 4. æ ¸å¿ƒåŠŸèƒ½ï¼šçµç®—æ¼”ç®—æ³• ---
        function calculateSettlement() {
            if (users.length === 0) return;

            const total = expenses.reduce((sum, e) => sum + e.amount, 0);
            const perPerson = total / users.length;

            document.getElementById('total-amount').innerText = total.toLocaleString();
            document.getElementById('average-amount').innerText = Math.round(perPerson).toLocaleString();

            // è¨ˆç®—æ¯äººé¤˜é¡ (æ­£æ•¸=å¤šä»˜äº†=æ‡‰æ”¶, è² æ•¸=å°‘ä»˜äº†=æ‡‰çµ¦)
            let balances = {};
            users.forEach(u => balances[u] = -perPerson); // å…ˆå‡è¨­å¤§å®¶éƒ½æ²’ä»˜éŒ¢ï¼Œæ¬ å¹³å‡å€¼
            
            expenses.forEach(e => {
                if (balances[e.payer] !== undefined) {
                    balances[e.payer] += e.amount;
                }
            });

            // åˆ†é›¢å‚µå‹™äººèˆ‡å‚µæ¬Šäºº
            let debtors = [];
            let creditors = [];

            for (let u in balances) {
                let val = balances[u];
                if (val < -0.01) debtors.push({ name: u, amount: val }); // æ¬ éŒ¢
                if (val > 0.01) creditors.push({ name: u, amount: val }); // æ‡‰æ”¶
            }

            // æ’åºï¼Œå¾å¤§é¡é–‹å§‹é…å°ï¼Œæ¸›å°‘äº¤æ˜“æ¬¡æ•¸
            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let resultHtml = '';
            let i = 0; // debtor index
            let j = 0; // creditor index

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                
                // å–å…©è€…çµ•å°å€¼è¼ƒå°è€…ç‚ºäº¤æ˜“é‡‘é¡
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                
                // é¡¯ç¤ºçµæœ (å››é›ªäº”å…¥)
                if (amount > 0.5) {
                    resultHtml += `<div class="result-item">
                        <b>${debtor.name}</b> çµ¦ <b>${creditor.name}</b> 
                        <span style="float:right; color:var(--primary); font-weight:bold;">$${Math.round(amount)}</span>
                    </div>`;
                }

                // æ›´æ–°é¤˜é¡
                debtor.amount += amount;
                creditor.amount -= amount;

                // å¦‚æœæ­¸é›¶å°±æ›ä¸‹ä¸€å€‹äºº
                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            if (resultHtml === '') {
                resultHtml = '<div style="text-align:center; color:#64748b;">ç›®å‰å¸³ç›®å¹³è¡¡ï¼Œç„¡é ˆè½‰å¸³ã€‚</div>';
            }
            
            document.getElementById('settlement-plan').innerHTML = resultHtml;
        }

        // --- 5. è³‡æ–™å­˜å–èˆ‡å‚™ä»½ ---
        function saveData() {
            localStorage.setItem('split_users', JSON.stringify(users));
            localStorage.setItem('split_expenses', JSON.stringify(expenses));
        }

        function clearAllData() {
            if (confirm('è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤æ‰€æœ‰äººå“¡å’Œå¸³å‹™ç´€éŒ„ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ')) {
                localStorage.clear();
                users = [];
                expenses = [];
                location.reload();
            }
        }

        function exportData() {
            const data = { users, expenses, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åˆ†å¸³å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.users && data.expenses) {
                        users = data.users;
                        expenses = data.expenses;
                        saveData();
                        location.reload();
                        alert('åŒ¯å…¥æˆåŠŸï¼');
                    } else {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    }
                } catch (err) {
                    alert('ç„¡æ³•è®€å–æª”æ¡ˆ');
                }
            };
            reader.readAsText(file);
        }

        // --- 6. æ¸²æŸ“è¼”åŠ©å‡½å¼ (Render Helpers) ---
        function renderUsers() {
            const list = document.getElementById('user-list');
            list.innerHTML = users.map((u, i) => `
                <div class="list-item">
                    <span>${u}</span>
                    <button class="btn-danger btn-small" onclick="removeUser(${i})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        function renderPayerOptions() {
            const select = document.getElementById('expense-payer');
            const currentVal = select.value;
            select.innerHTML = '<option value="" disabled selected>èª°å…ˆä»˜éŒ¢?</option>' + 
                users.map(u => `<option value="${u}">${u}</option>`).join('');
            if(users.includes(currentVal)) select.value = currentVal;
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            if (expenses.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">å°šç„¡ç´€éŒ„</div>';
                return;
            }

            // Group by Date
            let html = '';
            let lastDate = '';
            
            expenses.forEach(e => {
                if (e.date !== lastDate) {
                    html += `<div style="background:#e2e8f0; padding:5px 10px; font-size:0.85rem; font-weight:bold; margin-top:10px; border-radius:4px;">${e.date}</div>`;
                    lastDate = e.date;
                }
                html += `
                <div class="list-item">
                    <div style="flex:1;">
                        <div style="font-weight:500;">${e.desc}</div>
                        <div style="font-size:0.85rem; color:#64748b;">
                            <span class="tag">${e.payer} å…ˆä»˜</span>
                        </div>
                    </div>
                    <div style="font-weight:bold; margin-right:10px;">$${e.amount}</div>
                    <button class="btn-outline btn-small" style="border:none; color:#94a3b8;" onclick="deleteExpense(${e.id})">âœ•</button>
                </div>`;
            });
            list.innerHTML = html;
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`page-${pageId}`).classList.add('active');
            // Find nav item index based on pageId
            const index = pageId === 'log' ? 0 : 1;
            document.querySelectorAll('.nav-item')[index].classList.add('active');
        }
    </script>
</body>
</html>